<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Gestion Assurance Construction - SMA DWH</title>
    <link rel="apple-touch-icon" href="/static/icon-192.png">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Application de gestion des sinistres construction - Mode hors ligne disponible">
    <link rel="stylesheet" href="/static/styles.css?v=3">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="/static/db-manager.js"></script>
</head>
<body>
    <!-- Page de chargement avec disclaimer -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-logo">
                <i class="fas fa-building"></i>
            </div>
            <h1>SMA DWH</h1>
            <p class="loading-subtitle">Gestion Assurance Construction</p>
            <div class="loading-spinner">
                <div class="spinner"></div>
            </div>
            <div class="loading-disclaimer">
                <div class="disclaimer-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3>⚠️ Données d'Exemple</h3>
                <p>
                    Les données affichées dans cette application sont <strong>purement fictives</strong> 
                    et ont été générées automatiquement à l'aide d'un générateur de données synthétiques.
                </p>
                <p>
                    <strong>Ces données ne doivent pas être utilisées à des fins réelles.</strong>
                </p>
                <p class="disclaimer-note">
                    Cette démonstration est destinée uniquement à illustrer les fonctionnalités de l'application.
                </p>
            </div>
        </div>
    </div>
    
    <!-- Modale de téléchargement hors ligne -->
    <div id="offline-download-modal" class="modal-overlay">
        <div class="modal offline-modal">
            <div class="modal-header">
                <h3><i class="fas fa-download"></i> Téléchargement pour mode hors ligne</h3>
            </div>
            <div class="modal-body">
                <p class="modal-description">
                    Pour utiliser l'application sans connexion Internet, téléchargez toutes les données maintenant.
                </p>
                <div id="download-progress-container">
                    <div class="progress-info">
                        <span id="download-progress-text">Préparation...</span>
                        <span id="download-progress-percent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="download-progress-bar"></div>
                    </div>
                    <div id="download-stats"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btn-start-download" class="btn btn-primary">
                    <i class="fas fa-download"></i> Télécharger maintenant
                </button>
                <button id="btn-skip-download" class="btn btn-secondary">
                    Plus tard
                </button>
                <button id="btn-close-download" class="btn btn-secondary">
                    Fermer
                </button>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-building"></i> SMA DWH</h1>
                <p class="subtitle">Assurance Construction - Démo</p>
            </div>
            
            <nav class="sidebar-nav">
                <a href="#" class="nav-item active" data-view="dashboard">
                    <i class="fas fa-dashboard"></i>
                    <span>Tableau de bord</span>
                </a>
                <div class="nav-group open">
                    <a href="#" class="nav-item nav-group-toggle">
                        <i class="fas fa-shield-alt"></i>
                        <span>Assurance</span>
                        <i class="fas fa-chevron-down nav-group-arrow"></i>
                    </a>
                    <div class="nav-group-items">
                        <a href="#" class="nav-item nav-sub-item" data-view="clients">
                            <i class="fas fa-users"></i>
                            <span>Clients</span>
                        </a>
                        <a href="#" class="nav-item nav-sub-item" data-view="addresses">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>Adresses</span>
                        </a>
                        <a href="#" class="nav-item nav-sub-item" data-view="sites">
                            <i class="fas fa-hard-hat"></i>
                            <span>Chantiers</span>
                        </a>
                        <a href="#" class="nav-item nav-sub-item" data-view="contracts">
                            <i class="fas fa-file-contract"></i>
                            <span>Contrats</span>
                        </a>
                        <a href="#" class="nav-item nav-sub-item" data-view="claims">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Sinistres</span>
                        </a>
                        <a href="#" class="nav-item nav-sub-item" data-view="history">
                            <i class="fas fa-history"></i>
                            <span>Historique</span>
                        </a>
                    </div>
                </div>
                <a href="/static/claim_search.html" class="nav-item" target="_blank">
                    <i class="fas fa-search"></i>
                    <span>Recherche sinistres</span>
                    <i class="fas fa-external-link-alt external-link-icon"></i>
                </a>
                <a href="#" class="nav-item" data-view="referentials">
                    <i class="fas fa-database"></i>
                    <span>Référentiels</span>
                </a>
                <div class="nav-group">
                    <a href="#" class="nav-item nav-group-toggle">
                        <i class="fas fa-question-circle"></i>
                        <span>Aide</span>
                        <i class="fas fa-chevron-down nav-group-arrow"></i>
                    </a>
                    <div class="nav-group-items">
                        <a href="#" class="nav-item nav-sub-item" data-view="generate">
                            <i class="fas fa-magic"></i>
                            <span>Génération de données</span>
                        </a>
                        <a href="#" class="nav-item nav-sub-item" data-view="about">
                            <i class="fas fa-info-circle"></i>
                            <span>À propos</span>
                        </a>
                        <a href="/docs" class="nav-item nav-sub-item" target="_blank">
                            <i class="fas fa-book"></i>
                            <span>Documentation API</span>
                            <i class="fas fa-external-link-alt external-link-icon"></i>
                        </a>
                    </div>
                </div>
            </nav>
            
            <div class="sidebar-footer">
                <div class="api-status">
                    <i class="fas fa-circle" id="api-status-icon"></i>
                    <span id="api-status-text">Vérification...</span>
                </div>
                <button id="btn-sync-offline" class="btn btn-sm btn-secondary" title="Télécharger les données pour le mode hors ligne">
                    <i class="fas fa-download"></i> Mode hors ligne
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Header -->
            <header class="content-header">
                <div class="header-left">
                    <h2 id="page-title">Tableau de bord</h2>
                    <p id="page-subtitle">Vue d'ensemble de la base de données</p>
                </div>
                <div class="header-right">
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="global-search" placeholder="Rechercher un client...">
                        <button id="phonetic-toggle" class="btn-icon" title="Recherche phonétique">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Content Views -->
            <div class="content-body">
                <!-- Dashboard View -->
                <div id="dashboard-view" class="view active">
                    <div class="stats-grid">
                        <div class="stat-card" data-view="clients">
                            <div class="stat-icon bg-blue">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="stat-clients">0</h3>
                                <p>Clients</p>
                            </div>
                        </div>
                        <div class="stat-card" data-view="addresses">
                            <div class="stat-icon bg-green">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="stat-addresses">0</h3>
                                <p>Adresses</p>
                            </div>
                        </div>
                        <div class="stat-card" data-view="sites">
                            <div class="stat-icon bg-orange">
                                <i class="fas fa-hard-hat"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="stat-sites">0</h3>
                                <p>Chantiers</p>
                            </div>
                        </div>
                        <div class="stat-card" data-view="contracts">
                            <div class="stat-icon bg-purple">
                                <i class="fas fa-file-contract"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="stat-contracts">0</h3>
                                <p>Contrats</p>
                            </div>
                        </div>
                        <div class="stat-card" data-view="claims">
                            <div class="stat-icon bg-red">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="stat-claims">0</h3>
                                <p>Sinistres</p>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-grid">
                        <div class="dashboard-card">
                            <h3><i class="fas fa-chart-line"></i> Activité récente</h3>
                            <div id="recent-activity" class="activity-list"></div>
                        </div>
                        <div class="dashboard-card">
                            <h3><i class="fas fa-exclamation-triangle"></i> Alertes</h3>
                            <div id="alerts-list" class="alerts-list"></div>
                        </div>
                    </div>
                </div>

                <!-- Clients View -->
                <div id="clients-view" class="view">
                    <div class="view-toolbar">
                        <button class="btn btn-primary" onclick="showClientModal()">
                            <i class="fas fa-plus"></i> Nouveau client
                        </button>
                        <div class="toolbar-filters">
                            <select id="client-type-filter" aria-label="Filtrer par type de client">
                                <option value="">Tous les types</option>
                                <option value="particulier">Particulier</option>
                                <option value="professionnel">Professionnel</option>
                            </select>
                            <input type="text" id="client-search" placeholder="Rechercher...">
                            <button class="btn btn-secondary btn-sm" onclick="clearClientFilters()" title="Réinitialiser les filtres">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div id="clients-table-container"></div>
                    
                    <!-- Client Detail View -->
                    <div id="client-detail" class="detail-view">
                        <div class="view-toolbar">
                            <button class="btn btn-secondary" onclick="backToClientsList()">
                                <i class="fas fa-arrow-left"></i> Retour à la liste
                            </button>
                        </div>
                        <div id="client-detail-content"></div>
                    </div>
                </div>

                <!-- Addresses View -->
                <div id="addresses-view" class="view">
                    <div class="view-toolbar">
                        <button class="btn btn-primary" onclick="showAddressModal()">
                            <i class="fas fa-plus"></i> Nouvelle adresse
                        </button>
                        <button class="btn btn-secondary" onclick="showAddressesMap()">
                            <i class="fas fa-map"></i> Voir sur la carte
                        </button>
                        <div class="toolbar-filters">
                            <select id="address-type-filter" aria-label="Filtrer par type d'adresse">
                                <option value="">Tous les types</option>
                                <option value="siege_social">Siège social</option>
                                <option value="entrepot">Entrepôt</option>
                                <option value="chantier">Chantier</option>
                            </select>
                            <input type="text" id="address-search" placeholder="Rechercher...">
                            <button class="btn btn-secondary btn-sm" onclick="clearAddressFilters()" title="Réinitialiser les filtres">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div id="addresses-table-container"></div>
                    
                    <!-- Address Detail View -->
                    <div id="address-detail" class="detail-view">
                        <div class="view-toolbar">
                            <button class="btn btn-secondary" onclick="backToAddressesList()">
                                <i class="fas fa-arrow-left"></i> Retour à la liste
                            </button>
                        </div>
                        <div id="address-detail-content"></div>
                    </div>
                </div>

                <!-- Sites View -->
                <div id="sites-view" class="view">
                    <div class="view-toolbar">
                        <button class="btn btn-primary" onclick="showSiteModal()">
                            <i class="fas fa-plus"></i> Nouveau chantier
                        </button>
                        <button class="btn btn-secondary" onclick="showAllSitesMap()">
                            <i class="fas fa-map"></i> Voir la carte
                        </button>
                        <div class="toolbar-filters">
                            <select id="site-building-filter" aria-label="Filtrer par catégorie de bâtiment">
                                <option value="">Toutes les catégories</option>
                                <option value="HAB-IND">Habitation individuelle</option>
                                <option value="HAB-COL">Habitation collective</option>
                                <option value="COM">Commercial</option>
                                <option value="IND">Industriel</option>
                                <option value="AGR">Agricole</option>
                                <option value="ERP">ERP</option>
                                <option value="BUR">Bureaux</option>
                                <option value="MIX">Mixte</option>
                                <option value="IGH">IGH</option>
                                <option value="OAR">Ouvrage d'art</option>
                            </select>
                            <select id="site-work-filter" aria-label="Filtrer par catégorie de travaux">
                                <option value="">Tous les travaux</option>
                                <option value="CONST-NEUF">Construction neuve</option>
                                <option value="EXT">Extension</option>
                                <option value="RENOV-L">Rénovation légère</option>
                                <option value="RENOV-H">Rénovation lourde</option>
                                <option value="REHAB">Réhabilitation</option>
                                <option value="TRANSF">Transformation</option>
                                <option value="SURES">Surélévation</option>
                                <option value="SOUS-SOL">Travaux en sous-sol</option>
                            </select>
                            <input type="text" id="site-search" placeholder="Rechercher...">
                            <button class="btn btn-secondary btn-sm" onclick="clearSiteFilters()" title="Réinitialiser les filtres">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div id="sites-table-container"></div>
                    
                    <!-- Site Detail View -->
                    <div id="site-detail" class="detail-view">
                        <div class="view-toolbar">
                            <button class="btn btn-secondary" onclick="backToSitesList()">
                                <i class="fas fa-arrow-left"></i> Retour à la liste
                            </button>
                        </div>
                        <div id="site-detail-content"></div>
                    </div>
                </div>

                <!-- Contracts View -->
                <div id="contracts-view" class="view">
                    <div class="view-toolbar">
                        <button class="btn btn-primary" onclick="showContractModal()">
                            <i class="fas fa-plus"></i> Nouveau contrat
                        </button>
                        <div class="toolbar-filters">
                            <select id="contract-type-filter" aria-label="Filtrer par type de contrat">
                                <option value="">Tous les types</option>
                                <option value="RC-DEC">RC Décennale</option>
                                <option value="RC-PRO">RC Pro</option>
                                <option value="TRC">TRC</option>
                                <option value="DOM">Dommages Ouvrage</option>
                                <option value="CNR">CNR</option>
                            </select>
                            <select id="contract-status-filter" aria-label="Filtrer par statut de contrat">
                                <option value="">Tous les statuts</option>
                                <option value="brouillon">Brouillon</option>
                                <option value="en_attente">En attente</option>
                                <option value="actif">Actif</option>
                                <option value="expire">Expiré</option>
                                <option value="resilie">Résilié</option>
                            </select>
                            <input type="date" id="contract-date-from" placeholder="Date début">
                            <input type="date" id="contract-date-to" placeholder="Date fin">
                            <input type="text" id="contract-search" placeholder="Rechercher...">
                            <button class="btn btn-secondary btn-sm" onclick="clearContractFilters()" title="Réinitialiser les filtres">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div id="contracts-table-container"></div>
                    
                    <!-- Contract Detail View -->
                    <div id="contract-detail" class="detail-view">
                        <div class="view-toolbar">
                            <button class="btn btn-secondary" onclick="backToContractsList()">
                                <i class="fas fa-arrow-left"></i> Retour à la liste
                            </button>
                        </div>
                        <div id="contract-detail-content"></div>
                    </div>
                </div>

                <!-- Claims View -->
                <div id="claims-view" class="view">
                    <div class="view-toolbar">
                        <button class="btn btn-primary" onclick="showClaimModal()">
                            <i class="fas fa-plus"></i> Nouveau sinistre
                        </button>
                        <div class="toolbar-filters">
                            <select id="claim-status-filter" onchange="filterClaims()" aria-label="Filtrer par statut de sinistre">
                                <option value="">Tous les statuts</option>
                                <option value="declare">Déclaré</option>
                                <option value="pris_en_compte">Pris en compte</option>
                                <option value="en_cours_expertise">En cours d'expertise</option>
                                <option value="attente_pieces">Attente pièces</option>
                                <option value="accepte">Accepté</option>
                                <option value="refuse">Refusé</option>
                                <option value="regle">Réglé</option>
                                <option value="cloture">Clôturé</option>
                            </select>
                            <select id="claim-type-filter" onchange="filterClaims()" aria-label="Filtrer par type de sinistre">
                                <option value="">Tous les types</option>
                                <option value="structurel">Structurel</option>
                                <option value="degats_des_eaux">Dégâts des eaux</option>
                                <option value="incendie">Incendie</option>
                                <option value="intemperies">Intempéries</option>
                                <option value="vol">Vol</option>
                                <option value="vandalisme">Vandalisme</option>
                                <option value="malfacons">Malfaçons</option>
                                <option value="rc">Responsabilité civile</option>
                                <option value="autre">Autre</option>
                            </select>
                        </div>
                    </div>
                    <div id="claims-table-container"></div>
                    
                    <!-- Claim Detail View -->
                    <div id="claim-detail" class="detail-view">
                        <div class="view-toolbar">
                            <button class="btn btn-secondary" onclick="backToClaimsList()">
                                <i class="fas fa-arrow-left"></i> Retour à la liste
                            </button>
                            <button class="btn btn-primary" onclick="editClaim()">
                                <i class="fas fa-edit"></i> Modifier
                            </button>
                        </div>
                        <div id="claim-detail-content"></div>
                    </div>
                </div>
                <!-- Claim Search View -->
                <div id="claim-search-view" class="view">
                    <div class="view-toolbar">
                        <h2>Recherche de sinistres</h2>
                    </div>
                    
                    <div class="search-section">
                        <div class="search-flex">
                            <input type="text" id="claim-search-input" placeholder="Rechercher par numéro de sinistre, titre..." class="search-input">
                            <button class="btn btn-primary" onclick="searchClaimsAdvanced()">
                                <i class="fas fa-search"></i> Rechercher
                            </button>
                            <button class="btn btn-secondary" onclick="clearClaimSearch()" title="Effacer la recherche">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="claim-search-results"></div>
                    
                    <div id="claim-detail-view" class="detail-view">
                        <button class="btn btn-secondary back-button" onclick="backToClaimSearch()">
                            <i class="fas fa-arrow-left"></i> Retour aux résultats
                        </button>
                        <div class="detail-grid-2col">
                            <div id="claim-detail-left" class="detail-panel"></div>
                            <div id="claim-detail-right">
                                <div id="claim-client-summary" class="detail-panel-sm"></div>
                                <div id="claim-contract-summary" class="detail-panel-sm"></div>
                                <div id="claim-guarantees-list" class="detail-panel-sm"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Claim Search View -->
                <div id="claim-search-view" class="view">
                    <div class="view-toolbar">
                        <h2>Recherche de sinistres</h2>
                    </div>
                    
                    <div class="search-section">
                        <div class="search-flex">
                            <input type="text" id="claim-search-input-2" placeholder="Rechercher par numéro de sinistre, nom du client..." class="search-input">
                            <button class="btn btn-primary" onclick="searchClaimsAdvanced()">
                                <i class="fas fa-search"></i> Rechercher
                            </button>
                            <button class="btn btn-secondary" onclick="clearClaimSearch()" title="Effacer la recherche">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="claim-search-results"></div>
                    
                    <div id="claim-detail-view" class="detail-view">
                        <button class="btn btn-secondary back-button" onclick="backToClaimSearch()">
                            <i class="fas fa-arrow-left"></i> Retour aux résultats
                        </button>
                        <div class="detail-grid-2col">
                            <div id="claim-detail-left" class="detail-panel"></div>
                            <div id="claim-detail-right">
                                <div id="claim-client-summary" class="detail-panel-sm"></div>
                                <div id="claim-contract-summary" class="detail-panel-sm"></div>
                                <div id="claim-guarantees-list" class="detail-panel-sm"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History View -->
                <div id="history-view" class="view">
                    <div class="view-toolbar">
                        <div class="toolbar-filters">
                            <select id="history-action-filter" aria-label="Filtrer par type d'action">
                                <option value="">Toutes les actions</option>
                                <option value="creation">Création</option>
                                <option value="modification">Modification</option>
                                <option value="changement_statut">Changement statut</option>
                                <option value="renouvellement">Renouvellement</option>
                                <option value="resiliation">Résiliation</option>
                            </select>
                            <input type="date" id="history-date-from" placeholder="Date début">
                            <input type="date" id="history-date-to" placeholder="Date fin">
                        </div>
                    </div>
                    <div id="history-table-container"></div>
                </div>

                <!-- Generate View -->
                <div id="generate-view" class="view">
                    <div class="generate-container">
                        <div class="generate-card">
                            <h3><i class="fas fa-magic"></i> Génération de données de test</h3>
                            
                            <div class="form-group">
                                <label for="gen-count">Nombre de clients à générer</label>
                                <input type="number" id="gen-count" min="1" max="100" value="10">
                            </div>

                            <div class="form-group">
                                <label for="gen-type">Type de clients</label>
                                <select id="gen-type">
                                    <option value="mixte">Mixte (particuliers et entreprises)</option>
                                    <option value="particulier">Particuliers uniquement</option>
                                    <option value="entreprise">Entreprises uniquement</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="gen-clean" checked>
                                    Nettoyer les données existantes avant génération
                                </label>
                            </div>

                            <button class="btn btn-primary btn-large" onclick="generateData()">
                                <i class="fas fa-magic"></i> Générer les données
                            </button>

                            <div id="generate-progress" class="progress-container">
                                <div class="progress-bar">
                                    <div class="progress-fill"></div>
                                </div>
                                <p class="progress-text">Génération en cours...</p>
                            </div>
                        </div>

                        <div class="generate-card">
                            <h3><i class="fas fa-exclamation-triangle"></i> Génération de sinistres</h3>
                            
                            <div class="form-group">
                                <label for="gen-claims-count">Nombre de sinistres à générer</label>
                                <input type="number" id="gen-claims-count" min="1" max="100" value="15">
                            </div>

                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="gen-claims-clean">
                                    Nettoyer les sinistres existants avant génération
                                </label>
                            </div>

                            <button class="btn btn-primary btn-large" onclick="generateClaims()">
                                <i class="fas fa-plus"></i> Générer les sinistres
                            </button>
                        </div>

                        <div class="generate-card danger-zone">
                            <h3><i class="fas fa-exclamation-triangle"></i> Zone dangereuse</h3>
                            
                            <div class="form-group">
                                <label>Supprimer toutes les données</label>
                                <p class="help-text">Cette action supprimera tous les clients et leurs données associées (adresses, chantiers, contrats, historique).</p>
                                <button class="btn btn-danger" onclick="deleteAllData()">
                                    <i class="fas fa-trash"></i> Supprimer toutes les données
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Referentials View -->
                <div id="referentials-view" class="view">
                    <div class="referentials-grid">
                        <div class="ref-card" data-ref="contract_types">
                            <h3><i class="fas fa-file-contract"></i> Types de contrats</h3>
                            <p class="ref-count">0 types</p>
                            <button class="btn btn-sm" onclick="loadReferential('contract_types')">Voir</button>
                        </div>
                        <div class="ref-card" data-ref="guarantee_types">
                            <h3><i class="fas fa-shield-alt"></i> Garanties</h3>
                            <p class="ref-count">0 garanties</p>
                            <button class="btn btn-sm" onclick="loadReferential('guarantee_types')">Voir</button>
                        </div>
                        <div class="ref-card" data-ref="clauses">
                            <h3><i class="fas fa-file-alt"></i> Clauses</h3>
                            <p class="ref-count">0 clauses</p>
                            <button class="btn btn-sm" onclick="loadReferential('clauses')">Voir</button>
                        </div>
                        <div class="ref-card" data-ref="building_categories">
                            <h3><i class="fas fa-building"></i> Catégories de bâtiments</h3>
                            <p class="ref-count">0 catégories</p>
                            <button class="btn btn-sm" onclick="loadReferential('building_categories')">Voir</button>
                        </div>
                        <div class="ref-card" data-ref="work_categories">
                            <h3><i class="fas fa-tools"></i> Catégories de travaux</h3>
                            <p class="ref-count">0 catégories</p>
                            <button class="btn btn-sm" onclick="loadReferential('work_categories')">Voir</button>
                        </div>
                        <div class="ref-card" data-ref="professions">
                            <h3><i class="fas fa-user-tie"></i> Professions</h3>
                            <p class="ref-count">0 professions</p>
                            <button class="btn btn-sm" onclick="loadReferential('professions')">Voir</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- About View -->
            <div id="about-view" class="view">
                <div class="about-page">
                    <!-- Disclaimer -->
                    <div class="about-disclaimer">
                        <div class="about-disclaimer-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3>⚠️ Données d'Exemple</h3>
                        <p>
                            Les données affichées dans cette application sont <strong>purement fictives</strong>
                            et ont été générées automatiquement à l'aide d'un générateur de données synthétiques
                            (<strong>Faker</strong> pour Python).
                        </p>
                        <p>
                            <strong>Ces données ne doivent en aucun cas être utilisées à des fins réelles.</strong>
                            Elles sont destinées uniquement à illustrer les fonctionnalités de l'application.
                        </p>
                        <p class="about-disclaimer-note">
                            Tous les noms, adresses, numéros de contrats et sinistres sont entièrement fictifs.
                            Toute ressemblance avec des personnes, entreprises ou situations réelles serait purement fortuite.
                        </p>
                    </div>

                    <div class="about-grid">
                        <!-- Frontend -->
                        <div class="about-card">
                            <div class="about-card-header">
                                <i class="fas fa-laptop-code"></i>
                                <h3>Frontend (Client)</h3>
                            </div>
                            <div class="about-card-body">
                                <div class="about-tech-list">
                                    <div class="about-tech-item">
                                        <div class="about-tech-icon"><i class="fab fa-html5"></i></div>
                                        <div class="about-tech-info">
                                            <strong>HTML5 / CSS3 / JavaScript</strong>
                                            <span>Vanilla JS – Aucun framework frontend</span>
                                        </div>
                                    </div>
                                    <div class="about-tech-item">
                                        <div class="about-tech-icon"><i class="fas fa-mobile-alt"></i></div>
                                        <div class="about-tech-info">
                                            <strong>Progressive Web App (PWA)</strong>
                                            <span>Service Worker, IndexedDB, Manifest</span>
                                        </div>
                                    </div>
                                    <div class="about-tech-item">
                                        <div class="about-tech-icon"><i class="fas fa-map"></i></div>
                                        <div class="about-tech-info">
                                            <strong>Leaflet 1.9.4</strong>
                                            <span>Cartographie interactive (OpenStreetMap)</span>
                                        </div>
                                    </div>
                                    <div class="about-tech-item">
                                        <div class="about-tech-icon"><i class="fas fa-icons"></i></div>
                                        <div class="about-tech-info">
                                            <strong>Font Awesome 6.4</strong>
                                            <span>Bibliothèque d'icônes</span>
                                        </div>
                                    </div>
                                    <div class="about-tech-item">
                                        <div class="about-tech-icon"><i class="fas fa-database"></i></div>
                                        <div class="about-tech-info">
                                            <strong>IndexedDB</strong>
                                            <span>Stockage local pour le mode hors ligne</span>
                                        </div>
                                    </div>
                                    <div class="about-tech-item">
                                        <div class="about-tech-icon"><i class="fas fa-sync-alt"></i></div>
                                        <div class="about-tech-info">
                                            <strong>Synchronisation automatique</strong>
                                            <span>Sync bidirectionnelle toutes les 5 min</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Backend -->
                        <div class="about-card">
                            <div class="about-card-header">
                                <i class="fas fa-server"></i>
                                <h3>Backend (Serveur)</h3>
                            </div>
                            <div class="about-card-body">
                                <div class="about-tech-list">
                                    <div class="about-tech-item">
                                        <div class="about-tech-icon"><i class="fab fa-python"></i></div>
                                        <div class="about-tech-info">
                                            <strong>Python 3.11+</strong>
                                            <span>Langage principal du serveur</span>
                                        </div>
                                    </div>
                                    <div class="about-tech-item">
                                        <div class="about-tech-icon"><i class="fas fa-bolt"></i></div>
                                        <div class="about-tech-info">
                                            <strong>FastAPI 0.115</strong>
                                            <span>Framework web asynchrone hautes performances</span>
                                        </div>
                                    </div>
                                    <div class="about-tech-item">
                                        <div class="about-tech-icon"><i class="fas fa-rocket"></i></div>
                                        <div class="about-tech-info">
                                            <strong>Uvicorn 0.32</strong>
                                            <span>Serveur ASGI (HTTP/WebSocket)</span>
                                        </div>
                                    </div>
                                    <div class="about-tech-item">
                                        <div class="about-tech-icon"><i class="fas fa-check-circle"></i></div>
                                        <div class="about-tech-info">
                                            <strong>Pydantic 2.9</strong>
                                            <span>Validation des données et sérialisation</span>
                                        </div>
                                    </div>
                                    <div class="about-tech-item">
                                        <div class="about-tech-icon"><i class="fas fa-layer-group"></i></div>
                                        <div class="about-tech-info">
                                            <strong>SQLAlchemy 2.0</strong>
                                            <span>ORM et gestion de la base de données</span>
                                        </div>
                                    </div>
                                    <div class="about-tech-item">
                                        <div class="about-tech-icon"><i class="fas fa-database"></i></div>
                                        <div class="about-tech-info">
                                            <strong>PostgreSQL</strong>
                                            <span>Base de données relationnelle (psycopg2)</span>
                                        </div>
                                    </div>
                                    <div class="about-tech-item">
                                        <div class="about-tech-icon"><i class="fas fa-random"></i></div>
                                        <div class="about-tech-info">
                                            <strong>Faker 30.8</strong>
                                            <span>Génération de données fictives réalistes</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Infrastructure -->
                        <div class="about-card">
                            <div class="about-card-header">
                                <i class="fas fa-cloud"></i>
                                <h3>Infrastructure</h3>
                            </div>
                            <div class="about-card-body">
                                <div class="about-tech-list">
                                    <div class="about-tech-item">
                                        <div class="about-tech-icon"><i class="fab fa-docker"></i></div>
                                        <div class="about-tech-info">
                                            <strong>Docker</strong>
                                            <span>Conteneurisation de l'application</span>
                                        </div>
                                    </div>
                                    <div class="about-tech-item">
                                        <div class="about-tech-icon"><i class="fas fa-network-wired"></i></div>
                                        <div class="about-tech-info">
                                            <strong>Docker Compose</strong>
                                            <span>Orchestration multi-conteneurs</span>
                                        </div>
                                    </div>
                                    <div class="about-tech-item">
                                        <div class="about-tech-icon"><i class="fas fa-shield-alt"></i></div>
                                        <div class="about-tech-info">
                                            <strong>HTTPS / TLS</strong>
                                            <span>Communication sécurisée via proxy</span>
                                        </div>
                                    </div>
                                    <div class="about-tech-item">
                                        <div class="about-tech-icon"><i class="fas fa-book-open"></i></div>
                                        <div class="about-tech-info">
                                            <strong>Swagger / OpenAPI</strong>
                                            <span>Documentation API auto-générée</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="about-footer">
                        <p>SMA DWH — Application de démonstration — Version 1.0.0</p>
                        <p>Développée avec <i class="fas fa-heart about-heart"></i> et <i class="fab fa-github"></i> GitHub Copilot</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Template -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modal-title">Modal Title</h3>
                <button class="modal-close" onclick="closeModal()" title="Fermer">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer" id="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                <button class="btn btn-primary" id="modal-action">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container"></div>

    <!-- Map Modal -->
    <div id="map-modal" class="modal-overlay">
        <div class="modal modal-large">
            <div class="modal-header">
                <h3 id="map-modal-title">Carte des adresses</h3>
                <button class="modal-close" onclick="closeMapModal()" title="Fermer la carte">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body modal-body-nopadding">
                <div id="addresses-map" class="map-container"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeMapModal()">Fermer</button>
            </div>
        </div>
    </div>

    <script src="/static/api.js?v=5"></script>
    <script src="/static/phonetic.js?v=5"></script>
    <script src="/static/sync-manager.js"></script>
    <script src="/static/app.js?v=5"></script>
    
    <!-- Service Worker Registration -->
    <script>
        // Enregistrer le service worker pour le mode hors ligne
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/static/service-worker.js');
                    console.log('Service Worker enregistré avec succès:', registration.scope);
                    
                    // Afficher une notification si une mise à jour est disponible
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showOfflineNotification('Nouvelle version disponible ! Rechargez la page pour mettre à jour.', 'info');
                            }
                        });
                    });
                } catch (error) {
                    console.error('Erreur d\'enregistrement du Service Worker:', error);
                }
            });
        }
        
        // Afficher l'état de la connexion
        function updateOnlineStatus() {
            const status = navigator.onLine ? 'en ligne' : 'hors ligne';
            const color = navigator.onLine ? 'green' : 'orange';
            const btnSyncOffline = document.getElementById('btn-sync-offline');
            
            console.log(`Mode ${status}`);
            
            // Mettre à jour le bouton Mode hors ligne
            if (btnSyncOffline) {
                if (!navigator.onLine) {
                    btnSyncOffline.classList.remove('btn-secondary');
                    btnSyncOffline.classList.add('btn-danger');
                    btnSyncOffline.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Mode hors ligne actif';
                } else {
                    btnSyncOffline.classList.remove('btn-danger');
                    btnSyncOffline.classList.add('btn-secondary');
                    btnSyncOffline.innerHTML = '<i class="fas fa-download"></i> Mode hors ligne';
                }
            }
            
            // Afficher une notification visuelle
            showOfflineNotification(
                navigator.onLine ? 'Connexion restaurée' : 'Mode hors ligne - Les données sont disponibles localement',
                navigator.onLine ? 'success' : 'warning'
            );
        }
        
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        
        // Fonction pour afficher une notification
        function showOfflineNotification(message, type = 'info') {
            // Créer un élément de notification s'il n'existe pas
            let notification = document.getElementById('offline-notification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'offline-notification';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    max-width: 400px;
                    font-family: Arial, sans-serif;
                    font-size: 14px;
                    transition: opacity 0.3s, transform 0.3s;
                    transform: translateX(0);
                `;
                document.body.appendChild(notification);
            }
            
            // Définir les couleurs selon le type
            const colors = {
                success: { bg: '#d4edda', border: '#c3e6cb', text: '#155724' },
                warning: { bg: '#fff3cd', border: '#ffeaa7', text: '#856404' },
                info: { bg: '#d1ecf1', border: '#bee5eb', text: '#0c5460' },
                error: { bg: '#f8d7da', border: '#f5c6cb', text: '#721c24' }
            };
            
            const color = colors[type] || colors.info;
            notification.style.backgroundColor = color.bg;
            notification.style.borderLeft = `4px solid ${color.border}`;
            notification.style.color = color.text;
            notification.textContent = message;
            notification.style.opacity = '1';
            
            // Masquer automatiquement après 5 secondes
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(400px)';
            }, 5000);
        }
        
        // Fonctions pour gérer la modale de téléchargement hors ligne
        window.showOfflineDownloadModal = function() {
            const modal = document.getElementById('offline-download-modal');
            const progressContainer = document.getElementById('download-progress-container');
            const btnStart = document.getElementById('btn-start-download');
            const btnSkip = document.getElementById('btn-skip-download');
            const btnClose = document.getElementById('btn-close-download');
            
            modal.classList.add('active');
            progressContainer.classList.remove('active');
            btnStart.style.display = 'inline-block';
            btnSkip.style.display = 'inline-block';
            btnClose.style.display = 'none';
        };
        
        window.closeOfflineDownloadModal = function() {
            document.getElementById('offline-download-modal').classList.remove('active');
        };
        
        window.startOfflineDownload = async function() {
            const modal = document.getElementById('offline-download-modal');
            const progressContainer = document.getElementById('download-progress-container');
            const btnStart = document.getElementById('btn-start-download');
            const btnSkip = document.getElementById('btn-skip-download');
            const btnClose = document.getElementById('btn-close-download');
            const progressBar = document.getElementById('download-progress-bar');
            const progressText = document.getElementById('download-progress-text');
            const progressPercent = document.getElementById('download-progress-percent');
            const downloadStats = document.getElementById('download-stats');
            
            // Afficher la modale et la barre de progression
            modal.classList.add('active');
            progressContainer.classList.add('active');
            btnStart.style.display = 'none';
            btnSkip.style.display = 'none';
            
            let finalStats = null;
            
            try {
                // Lancer le téléchargement avec callback de progression
                finalStats = await api.downloadAllData((current, total, message, completed = false, error = false) => {
                    const percent = Math.round((current / total) * 100);
                    progressBar.style.width = percent + '%';
                    progressPercent.textContent = percent + '%';
                    progressText.textContent = message;
                    
                    if (error) {
                        progressBar.style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
                        progressText.style.color = '#dc2626';
                        btnClose.style.display = 'inline-block';
                    } else if (completed) {
                        progressBar.style.background = 'linear-gradient(90deg, #10b981, #059669)';
                        progressText.style.color = '#059669';
                        btnClose.style.display = 'inline-block';
                    }
                });
                
                // Afficher les statistiques après téléchargement
                if (finalStats) {
                    downloadStats.classList.add('active');
                    downloadStats.innerHTML = `
                        <strong>Téléchargement terminé !</strong><br>
                        📊 <strong>${finalStats.claims || 0}</strong> sinistres<br>
                        👥 <strong>${finalStats.clients || 0}</strong> clients<br>
                        📄 <strong>${finalStats.contracts || 0}</strong> contrats<br>
                        <br>
                        <em>Vous pouvez maintenant utiliser l'application hors ligne.</em>
                    `;
                }
            } catch (error) {
                console.error('Erreur lors du téléchargement:', error);
                progressBar.style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
                progressText.textContent = 'Erreur: ' + error.message;
                progressText.style.color = '#dc2626';
                btnClose.style.display = 'inline-block';
            }
        };
        
        // Gestionnaires d'événements pour la modale
        document.addEventListener('DOMContentLoaded', () => {
            const btnStart = document.getElementById('btn-start-download');
            const btnSkip = document.getElementById('btn-skip-download');
            const btnClose = document.getElementById('btn-close-download');
            const btnSyncOffline = document.getElementById('btn-sync-offline');
            
            if (btnStart) {
                btnStart.addEventListener('click', startOfflineDownload);
            }
            
            if (btnSkip) {
                btnSkip.addEventListener('click', closeOfflineDownloadModal);
            }
            
            if (btnClose) {
                btnClose.addEventListener('click', closeOfflineDownloadModal);
            }
            
            if (btnSyncOffline) {
                btnSyncOffline.addEventListener('click', () => {
                    showOfflineDownloadModal();
                });
            }
            
            // Initialiser l'état du bouton au chargement
            updateOnlineStatus();
            
            // Rendre les cartes du dashboard cliquables
            document.querySelectorAll('.stat-card[data-view]').forEach(card => {
                card.addEventListener('click', function() {
                    const view = this.getAttribute('data-view');
                    // Cliquer sur l'élément de navigation correspondant
                    const navItem = document.querySelector(`.nav-item[data-view="${view}"]`);
                    if (navItem) {
                        navItem.click();
                    }
                });
                
                // Ajouter un effet hover
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-4px)';
                    this.style.boxShadow = '0 8px 16px rgba(0, 0, 0, 0.15)';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.transform = '';
                    this.style.boxShadow = '';
                });
            });
        });
    </script>
</body>
</html>
