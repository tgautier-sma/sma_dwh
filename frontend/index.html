<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Gestion Assurance Construction - SMA DWH</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Application de gestion des sinistres construction - Mode hors ligne disponible">
    <link rel="stylesheet" href="/static/styles.css?v=3">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="/static/db-manager.js"></script>
</head>
<body>
    <!-- Modale de t√©l√©chargement hors ligne -->
    <div id="offline-download-modal" class="modal-overlay" style="display: none;">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-download"></i> T√©l√©chargement pour mode hors ligne</h3>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px;">
                    Pour utiliser l'application sans connexion Internet, t√©l√©chargez toutes les donn√©es maintenant.
                </p>
                <div id="download-progress-container" style="display: none;">
                    <div class="progress-info" style="margin-bottom: 10px; display: flex; justify-content: space-between;">
                        <span id="download-progress-text">Pr√©paration...</span>
                        <span id="download-progress-percent">0%</span>
                    </div>
                    <div class="progress-bar" style="width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                        <div id="download-progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #3b82f6, #2563eb); transition: width 0.3s ease;"></div>
                    </div>
                    <div id="download-stats" style="margin-top: 15px; padding: 10px; background: #f3f4f6; border-radius: 4px; font-size: 0.9em; display: none;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btn-start-download" class="btn btn-primary">
                    <i class="fas fa-download"></i> T√©l√©charger maintenant
                </button>
                <button id="btn-skip-download" class="btn btn-secondary">
                    Plus tard
                </button>
                <button id="btn-close-download" class="btn btn-secondary" style="display: none;">
                    Fermer
                </button>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-building"></i> SMA DWH</h1>
                <p class="subtitle">Assurance Construction - D√©mo</p>
            </div>
            
            <nav class="sidebar-nav">
                <a href="#" class="nav-item active" data-view="dashboard">
                    <i class="fas fa-dashboard"></i>
                    <span>Tableau de bord</span>
                </a>
                <a href="#" class="nav-item" data-view="clients">
                    <i class="fas fa-users"></i>
                    <span>Clients</span>
                </a>
                <a href="#" class="nav-item" data-view="addresses">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Adresses</span>
                </a>
                <a href="#" class="nav-item" data-view="sites">
                    <i class="fas fa-hard-hat"></i>
                    <span>Chantiers</span>
                </a>
                <a href="#" class="nav-item" data-view="contracts">
                    <i class="fas fa-file-contract"></i>
                    <span>Contrats</span>
                </a>
                <a href="#" class="nav-item" data-view="claims">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Sinistres</span>
                </a>
                <a href="#" class="nav-item" data-view="history">
                    <i class="fas fa-history"></i>
                    <span>Historique</span>
</a>
                <a href="/static/claim_search.html" class="nav-item" target="_blank">
                    <i class="fas fa-search"></i>
                    <span>Recherche sinistres</span>
                    <i class="fas fa-external-link-alt" style="margin-left: auto; font-size: 0.8em; opacity: 0.6;"></i>
                </a>
                <a href="#" class="nav-item" data-view="generate">
                    <i class="fas fa-magic"></i>
                    <span>G√©n√©ration de donn√©es</span>
                </a>
                <a href="#" class="nav-item" data-view="referentials">
                    <i class="fas fa-database"></i>
                    <span>R√©f√©rentiels</span>
                </a>
                <a href="/docs" class="nav-item" target="_blank">
                    <i class="fas fa-book"></i>
                    <span>Documentation API</span>
                    <i class="fas fa-external-link-alt" style="margin-left: auto; font-size: 0.8em; opacity: 0.6;"></i>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <div class="api-status">
                    <i class="fas fa-circle" id="api-status-icon"></i>
                    <span id="api-status-text">V√©rification...</span>
                </div>
                <button id="btn-sync-offline" class="btn btn-sm btn-secondary" style="width: 100%; margin-top: 10px;" title="T√©l√©charger les donn√©es pour le mode hors ligne">
                    <i class="fas fa-download"></i> Mode hors ligne
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Header -->
            <header class="content-header">
                <div class="header-left">
                    <h2 id="page-title">Tableau de bord</h2>
                    <p id="page-subtitle">Vue d'ensemble de la base de donn√©es</p>
                </div>
                <div class="header-right">
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="global-search" placeholder="Rechercher un client...">
                        <button id="phonetic-toggle" class="btn-icon" title="Recherche phon√©tique">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Content Views -->
            <div class="content-body">
                <!-- Dashboard View -->
                <div id="dashboard-view" class="view active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon bg-blue">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="stat-clients">0</h3>
                                <p>Clients</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon bg-green">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="stat-addresses">0</h3>
                                <p>Adresses</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon bg-orange">
                                <i class="fas fa-hard-hat"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="stat-sites">0</h3>
                                <p>Chantiers</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon bg-purple">
                                <i class="fas fa-file-contract"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="stat-contracts">0</h3>
                                <p>Contrats</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon bg-red">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="stat-claims">0</h3>
                                <p>Sinistres</p>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-grid">
                        <div class="dashboard-card">
                            <h3><i class="fas fa-chart-line"></i> Activit√© r√©cente</h3>
                            <div id="recent-activity" class="activity-list"></div>
                        </div>
                        <div class="dashboard-card">
                            <h3><i class="fas fa-exclamation-triangle"></i> Alertes</h3>
                            <div id="alerts-list" class="alerts-list"></div>
                        </div>
                    </div>
                </div>

                <!-- Clients View -->
                <div id="clients-view" class="view">
                    <div class="view-toolbar">
                        <button class="btn btn-primary" onclick="showClientModal()">
                            <i class="fas fa-plus"></i> Nouveau client
                        </button>
                        <div class="toolbar-filters">
                            <select id="client-type-filter">
                                <option value="">Tous les types</option>
                                <option value="particulier">Particulier</option>
                                <option value="professionnel">Professionnel</option>
                            </select>
                            <input type="text" id="client-search" placeholder="Rechercher...">
                            <button class="btn btn-secondary btn-sm" onclick="clearClientFilters()" title="R√©initialiser les filtres">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div id="clients-table-container"></div>
                    
                    <!-- Client Detail View -->
                    <div id="client-detail" style="display: none;">
                        <div class="view-toolbar">
                            <button class="btn btn-secondary" onclick="backToClientsList()">
                                <i class="fas fa-arrow-left"></i> Retour √† la liste
                            </button>
                        </div>
                        <div id="client-detail-content"></div>
                    </div>
                </div>

                <!-- Addresses View -->
                <div id="addresses-view" class="view">
                    <div class="view-toolbar">
                        <button class="btn btn-primary" onclick="showAddressModal()">
                            <i class="fas fa-plus"></i> Nouvelle adresse
                        </button>
                        <button class="btn btn-secondary" onclick="showAddressesMap()">
                            <i class="fas fa-map"></i> Voir sur la carte
                        </button>
                        <div class="toolbar-filters">
                            <select id="address-type-filter">
                                <option value="">Tous les types</option>
                                <option value="siege_social">Si√®ge social</option>
                                <option value="entrepot">Entrep√¥t</option>
                                <option value="chantier">Chantier</option>
                            </select>
                            <input type="text" id="address-search" placeholder="Rechercher...">
                            <button class="btn btn-secondary btn-sm" onclick="clearAddressFilters()" title="R√©initialiser les filtres">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div id="addresses-table-container"></div>
                    
                    <!-- Address Detail View -->
                    <div id="address-detail" style="display: none;">
                        <div class="view-toolbar">
                            <button class="btn btn-secondary" onclick="backToAddressesList()">
                                <i class="fas fa-arrow-left"></i> Retour √† la liste
                            </button>
                        </div>
                        <div id="address-detail-content"></div>
                    </div>
                </div>

                <!-- Sites View -->
                <div id="sites-view" class="view">
                    <div class="view-toolbar">
                        <button class="btn btn-primary" onclick="showSiteModal()">
                            <i class="fas fa-plus"></i> Nouveau chantier
                        </button>
                        <button class="btn btn-secondary" onclick="showAllSitesMap()">
                            <i class="fas fa-map"></i> Voir la carte
                        </button>
                        <div class="toolbar-filters">
                            <select id="site-building-filter">
                                <option value="">Toutes les cat√©gories</option>
                                <option value="HAB-IND">Habitation individuelle</option>
                                <option value="HAB-COL">Habitation collective</option>
                                <option value="COM">Commercial</option>
                                <option value="IND">Industriel</option>
                                <option value="AGR">Agricole</option>
                                <option value="ERP">ERP</option>
                                <option value="BUR">Bureaux</option>
                                <option value="MIX">Mixte</option>
                                <option value="IGH">IGH</option>
                                <option value="OAR">Ouvrage d'art</option>
                            </select>
                            <select id="site-work-filter">
                                <option value="">Tous les travaux</option>
                                <option value="CONST-NEUF">Construction neuve</option>
                                <option value="EXT">Extension</option>
                                <option value="RENOV-L">R√©novation l√©g√®re</option>
                                <option value="RENOV-H">R√©novation lourde</option>
                                <option value="REHAB">R√©habilitation</option>
                                <option value="TRANSF">Transformation</option>
                                <option value="SURES">Sur√©l√©vation</option>
                                <option value="SOUS-SOL">Travaux en sous-sol</option>
                            </select>
                            <input type="text" id="site-search" placeholder="Rechercher...">
                            <button class="btn btn-secondary btn-sm" onclick="clearSiteFilters()" title="R√©initialiser les filtres">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div id="sites-table-container"></div>
                    
                    <!-- Site Detail View -->
                    <div id="site-detail" style="display: none;">
                        <div class="view-toolbar">
                            <button class="btn btn-secondary" onclick="backToSitesList()">
                                <i class="fas fa-arrow-left"></i> Retour √† la liste
                            </button>
                        </div>
                        <div id="site-detail-content"></div>
                    </div>
                </div>

                <!-- Contracts View -->
                <div id="contracts-view" class="view">
                    <div class="view-toolbar">
                        <button class="btn btn-primary" onclick="showContractModal()">
                            <i class="fas fa-plus"></i> Nouveau contrat
                        </button>
                        <div class="toolbar-filters">
                            <select id="contract-type-filter">
                                <option value="">Tous les types</option>
                                <option value="RC-DEC">RC D√©cennale</option>
                                <option value="RC-PRO">RC Pro</option>
                                <option value="TRC">TRC</option>
                                <option value="DOM">Dommages Ouvrage</option>
                                <option value="CNR">CNR</option>
                            </select>
                            <select id="contract-status-filter">
                                <option value="">Tous les statuts</option>
                                <option value="brouillon">Brouillon</option>
                                <option value="en_attente">En attente</option>
                                <option value="actif">Actif</option>
                                <option value="expire">Expir√©</option>
                                <option value="resilie">R√©sili√©</option>
                            </select>
                            <input type="date" id="contract-date-from" placeholder="Date d√©but">
                            <input type="date" id="contract-date-to" placeholder="Date fin">
                            <input type="text" id="contract-search" placeholder="Rechercher...">
                            <button class="btn btn-secondary btn-sm" onclick="clearContractFilters()" title="R√©initialiser les filtres">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div id="contracts-table-container"></div>
                    
                    <!-- Contract Detail View -->
                    <div id="contract-detail" style="display: none;">
                        <div class="view-toolbar">
                            <button class="btn btn-secondary" onclick="backToContractsList()">
                                <i class="fas fa-arrow-left"></i> Retour √† la liste
                            </button>
                        </div>
                        <div id="contract-detail-content"></div>
                    </div>
                </div>

                <!-- Claims View -->
                <div id="claims-view" class="view">
                    <div class="view-toolbar">
                        <button class="btn btn-primary" onclick="showClaimModal()">
                            <i class="fas fa-plus"></i> Nouveau sinistre
                        </button>
                        <div class="toolbar-filters">
                            <select id="claim-status-filter" onchange="filterClaims()">
                                <option value="">Tous les statuts</option>
                                <option value="declare">D√©clar√©</option>
                                <option value="pris_en_compte">Pris en compte</option>
                                <option value="en_cours_expertise">En cours d'expertise</option>
                                <option value="attente_pieces">Attente pi√®ces</option>
                                <option value="accepte">Accept√©</option>
                                <option value="refuse">Refus√©</option>
                                <option value="regle">R√©gl√©</option>
                                <option value="cloture">Cl√¥tur√©</option>
                            </select>
                            <select id="claim-type-filter" onchange="filterClaims()">
                                <option value="">Tous les types</option>
                                <option value="structurel">Structurel</option>
                                <option value="degats_des_eaux">D√©g√¢ts des eaux</option>
                                <option value="incendie">Incendie</option>
                                <option value="intemperies">Intemp√©ries</option>
                                <option value="vol">Vol</option>
                                <option value="vandalisme">Vandalisme</option>
                                <option value="malfacons">Malfa√ßons</option>
                                <option value="rc">Responsabilit√© civile</option>
                                <option value="autre">Autre</option>
                            </select>
                        </div>
                    </div>
                    <div id="claims-table-container"></div>
                    
                    <!-- Claim Detail View -->
                    <div id="claim-detail" style="display: none;">
                        <div class="view-toolbar">
                            <button class="btn btn-secondary" onclick="backToClaimsList()">
                                <i class="fas fa-arrow-left"></i> Retour √† la liste
                            </button>
                            <button class="btn btn-primary" onclick="editClaim()">
                                <i class="fas fa-edit"></i> Modifier
                            </button>
                        </div>
                        <div id="claim-detail-content"></div>
                    </div>
                </div>
                <!-- Claim Search View -->
                <div id="claim-search-view" class="view">
                    <div class="view-toolbar">
                        <h2>Recherche de sinistres</h2>
                    </div>
                    
                    <div class="search-section" style="background: var(--bg-primary); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <input type="text" id="claim-search-input" placeholder="Rechercher par num√©ro de sinistre, titre..." style="flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                            <button class="btn btn-primary" onclick="searchClaimsAdvanced()">
                                <i class="fas fa-search"></i> Rechercher
                            </button>
                            <button class="btn btn-secondary" onclick="clearClaimSearch()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="claim-search-results"></div>
                    
                    <div id="claim-detail-view" style="display: none;">
                        <button class="btn btn-secondary" onclick="backToClaimSearch()" style="margin-bottom: 16px;">
                            <i class="fas fa-arrow-left"></i> Retour aux r√©sultats
                        </button>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div id="claim-detail-left" style="background: var(--bg-primary); padding: 20px; border-radius: 8px;"></div>
                            <div id="claim-detail-right">
                                <div id="claim-client-summary" style="background: var(--bg-primary); padding: 16px; border-radius: 8px; margin-bottom: 16px;"></div>
                                <div id="claim-contract-summary" style="background: var(--bg-primary); padding: 16px; border-radius: 8px; margin-bottom: 16px;"></div>
                                <div id="claim-guarantees-list" style="background: var(--bg-primary); padding: 16px; border-radius: 8px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Claim Search View -->
                <div id="claim-search-view" class="view">
                    <div class="view-toolbar">
                        <h2>Recherche de sinistres</h2>
                    </div>
                    
                    <div class="search-section" style="background: var(--bg-primary); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <input type="text" id="claim-search-input" placeholder="Rechercher par num√©ro de sinistre, nom du client..." style="flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                            <button class="btn btn-primary" onclick="searchClaimsAdvanced()">
                                <i class="fas fa-search"></i> Rechercher
                            </button>
                            <button class="btn btn-secondary" onclick="clearClaimSearch()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="claim-search-results"></div>
                    
                    <div id="claim-detail-view" style="display: none;">
                        <button class="btn btn-secondary" onclick="backToClaimSearch()" style="margin-bottom: 16px;">
                            <i class="fas fa-arrow-left"></i> Retour aux r√©sultats
                        </button>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div id="claim-detail-left" style="background: var(--bg-primary); padding: 20px; border-radius: 8px;"></div>
                            <div id="claim-detail-right">
                                <div id="claim-client-summary" style="background: var(--bg-primary); padding: 16px; border-radius: 8px; margin-bottom: 16px;"></div>
                                <div id="claim-contract-summary" style="background: var(--bg-primary); padding: 16px; border-radius: 8px; margin-bottom: 16px;"></div>
                                <div id="claim-guarantees-list" style="background: var(--bg-primary); padding: 16px; border-radius: 8px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History View -->
                <div id="history-view" class="view">
                    <div class="view-toolbar">
                        <div class="toolbar-filters">
                            <select id="history-action-filter">
                                <option value="">Toutes les actions</option>
                                <option value="creation">Cr√©ation</option>
                                <option value="modification">Modification</option>
                                <option value="changement_statut">Changement statut</option>
                                <option value="renouvellement">Renouvellement</option>
                                <option value="resiliation">R√©siliation</option>
                            </select>
                            <input type="date" id="history-date-from" placeholder="Date d√©but">
                            <input type="date" id="history-date-to" placeholder="Date fin">
                        </div>
                    </div>
                    <div id="history-table-container"></div>
                </div>

                <!-- Generate View -->
                <div id="generate-view" class="view">
                    <div class="generate-container">
                        <div class="generate-card">
                            <h3><i class="fas fa-magic"></i> G√©n√©ration de donn√©es de test</h3>
                            
                            <div class="form-group">
                                <label for="gen-count">Nombre de clients √† g√©n√©rer</label>
                                <input type="number" id="gen-count" min="1" max="100" value="10">
                            </div>

                            <div class="form-group">
                                <label for="gen-type">Type de clients</label>
                                <select id="gen-type">
                                    <option value="mixte">Mixte (particuliers et entreprises)</option>
                                    <option value="particulier">Particuliers uniquement</option>
                                    <option value="entreprise">Entreprises uniquement</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="gen-clean" checked>
                                    Nettoyer les donn√©es existantes avant g√©n√©ration
                                </label>
                            </div>

                            <button class="btn btn-primary btn-large" onclick="generateData()">
                                <i class="fas fa-magic"></i> G√©n√©rer les donn√©es
                            </button>

                            <div id="generate-progress" class="progress-container" style="display: none;">
                                <div class="progress-bar">
                                    <div class="progress-fill"></div>
                                </div>
                                <p class="progress-text">G√©n√©ration en cours...</p>
                            </div>
                        </div>

                        <div class="generate-card">
                            <h3><i class="fas fa-exclamation-triangle"></i> G√©n√©ration de sinistres</h3>
                            
                            <div class="form-group">
                                <label for="gen-claims-count">Nombre de sinistres √† g√©n√©rer</label>
                                <input type="number" id="gen-claims-count" min="1" max="100" value="15">
                            </div>

                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="gen-claims-clean">
                                    Nettoyer les sinistres existants avant g√©n√©ration
                                </label>
                            </div>

                            <button class="btn btn-primary btn-large" onclick="generateClaims()">
                                <i class="fas fa-plus"></i> G√©n√©rer les sinistres
                            </button>
                        </div>

                        <div class="generate-card danger-zone">
                            <h3><i class="fas fa-exclamation-triangle"></i> Zone dangereuse</h3>
                            
                            <div class="form-group">
                                <label>Supprimer toutes les donn√©es</label>
                                <p class="help-text">Cette action supprimera tous les clients et leurs donn√©es associ√©es (adresses, chantiers, contrats, historique).</p>
                                <button class="btn btn-danger" onclick="deleteAllData()">
                                    <i class="fas fa-trash"></i> Supprimer toutes les donn√©es
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Referentials View -->
                <div id="referentials-view" class="view">
                    <div class="referentials-grid">
                        <div class="ref-card" data-ref="contract_types">
                            <h3><i class="fas fa-file-contract"></i> Types de contrats</h3>
                            <p class="ref-count">0 types</p>
                            <button class="btn btn-sm" onclick="loadReferential('contract_types')">Voir</button>
                        </div>
                        <div class="ref-card" data-ref="guarantee_types">
                            <h3><i class="fas fa-shield-alt"></i> Garanties</h3>
                            <p class="ref-count">0 garanties</p>
                            <button class="btn btn-sm" onclick="loadReferential('guarantee_types')">Voir</button>
                        </div>
                        <div class="ref-card" data-ref="clauses">
                            <h3><i class="fas fa-file-alt"></i> Clauses</h3>
                            <p class="ref-count">0 clauses</p>
                            <button class="btn btn-sm" onclick="loadReferential('clauses')">Voir</button>
                        </div>
                        <div class="ref-card" data-ref="building_categories">
                            <h3><i class="fas fa-building"></i> Cat√©gories de b√¢timents</h3>
                            <p class="ref-count">0 cat√©gories</p>
                            <button class="btn btn-sm" onclick="loadReferential('building_categories')">Voir</button>
                        </div>
                        <div class="ref-card" data-ref="work_categories">
                            <h3><i class="fas fa-tools"></i> Cat√©gories de travaux</h3>
                            <p class="ref-count">0 cat√©gories</p>
                            <button class="btn btn-sm" onclick="loadReferential('work_categories')">Voir</button>
                        </div>
                        <div class="ref-card" data-ref="professions">
                            <h3><i class="fas fa-user-tie"></i> Professions</h3>
                            <p class="ref-count">0 professions</p>
                            <button class="btn btn-sm" onclick="loadReferential('professions')">Voir</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Template -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modal-title">Modal Title</h3>
                <button class="modal-close" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer" id="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                <button class="btn btn-primary" id="modal-action">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container"></div>

    <!-- Map Modal -->
    <div id="map-modal" class="modal-overlay">
        <div class="modal modal-large">
            <div class="modal-header">
                <h3 id="map-modal-title">Carte des adresses</h3>
                <button class="modal-close" onclick="closeMapModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div id="addresses-map" style="height: 70vh; width: 100%;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeMapModal()">Fermer</button>
            </div>
        </div>
    </div>

    <script src="/static/api.js?v=5"></script>
    <script src="/static/phonetic.js?v=5"></script>
    <script src="/static/sync-manager.js"></script>
    <script src="/static/app.js?v=5"></script>
    
    <!-- Service Worker Registration -->
    <script>
        // Enregistrer le service worker pour le mode hors ligne
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/static/service-worker.js');
                    console.log('Service Worker enregistr√© avec succ√®s:', registration.scope);
                    
                    // Afficher une notification si une mise √† jour est disponible
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showOfflineNotification('Nouvelle version disponible ! Rechargez la page pour mettre √† jour.', 'info');
                            }
                        });
                    });
                } catch (error) {
                    console.error('Erreur d\'enregistrement du Service Worker:', error);
                }
            });
        }
        
        // Afficher l'√©tat de la connexion
        function updateOnlineStatus() {
            const status = navigator.onLine ? 'en ligne' : 'hors ligne';
            const color = navigator.onLine ? 'green' : 'orange';
            const btnSyncOffline = document.getElementById('btn-sync-offline');
            
            console.log(`Mode ${status}`);
            
            // Mettre √† jour le bouton Mode hors ligne
            if (btnSyncOffline) {
                if (!navigator.onLine) {
                    btnSyncOffline.classList.remove('btn-secondary');
                    btnSyncOffline.classList.add('btn-success');
                    btnSyncOffline.innerHTML = '<i class="fas fa-check-circle"></i> Mode hors ligne actif';
                } else {
                    btnSyncOffline.classList.remove('btn-success');
                    btnSyncOffline.classList.add('btn-secondary');
                    btnSyncOffline.innerHTML = '<i class="fas fa-download"></i> Mode hors ligne';
                }
            }
            
            // Afficher une notification visuelle
            showOfflineNotification(
                navigator.onLine ? 'Connexion restaur√©e' : 'Mode hors ligne - Les donn√©es sont disponibles localement',
                navigator.onLine ? 'success' : 'warning'
            );
        }
        
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        
        // Fonction pour afficher une notification
        function showOfflineNotification(message, type = 'info') {
            // Cr√©er un √©l√©ment de notification s'il n'existe pas
            let notification = document.getElementById('offline-notification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'offline-notification';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    max-width: 400px;
                    font-family: Arial, sans-serif;
                    font-size: 14px;
                    transition: opacity 0.3s, transform 0.3s;
                    transform: translateX(0);
                `;
                document.body.appendChild(notification);
            }
            
            // D√©finir les couleurs selon le type
            const colors = {
                success: { bg: '#d4edda', border: '#c3e6cb', text: '#155724' },
                warning: { bg: '#fff3cd', border: '#ffeaa7', text: '#856404' },
                info: { bg: '#d1ecf1', border: '#bee5eb', text: '#0c5460' },
                error: { bg: '#f8d7da', border: '#f5c6cb', text: '#721c24' }
            };
            
            const color = colors[type] || colors.info;
            notification.style.backgroundColor = color.bg;
            notification.style.borderLeft = `4px solid ${color.border}`;
            notification.style.color = color.text;
            notification.textContent = message;
            notification.style.opacity = '1';
            
            // Masquer automatiquement apr√®s 5 secondes
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(400px)';
            }, 5000);
        }
        
        // Fonctions pour g√©rer la modale de t√©l√©chargement hors ligne
        window.showOfflineDownloadModal = function() {
            const modal = document.getElementById('offline-download-modal');
            const progressContainer = document.getElementById('download-progress-container');
            const btnStart = document.getElementById('btn-start-download');
            const btnSkip = document.getElementById('btn-skip-download');
            const btnClose = document.getElementById('btn-close-download');
            
            modal.style.display = 'flex';
            progressContainer.style.display = 'none';
            btnStart.style.display = 'inline-block';
            btnSkip.style.display = 'inline-block';
            btnClose.style.display = 'none';
        };
        
        window.closeOfflineDownloadModal = function() {
            document.getElementById('offline-download-modal').style.display = 'none';
        };
        
        window.startOfflineDownload = async function() {
            const progressContainer = document.getElementById('download-progress-container');
            const btnStart = document.getElementById('btn-start-download');
            const btnSkip = document.getElementById('btn-skip-download');
            const btnClose = document.getElementById('btn-close-download');
            const progressBar = document.getElementById('download-progress-bar');
            const progressText = document.getElementById('download-progress-text');
            const progressPercent = document.getElementById('download-progress-percent');
            const downloadStats = document.getElementById('download-stats');
            
            // Afficher la barre de progression
            progressContainer.style.display = 'block';
            btnStart.style.display = 'none';
            btnSkip.style.display = 'none';
            
            let finalStats = null;
            
            try {
                // Lancer le t√©l√©chargement avec callback de progression
                finalStats = await api.downloadAllData((current, total, message, completed = false, error = false) => {
                    const percent = Math.round((current / total) * 100);
                    progressBar.style.width = percent + '%';
                    progressPercent.textContent = percent + '%';
                    progressText.textContent = message;
                    
                    if (error) {
                        progressBar.style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
                        progressText.style.color = '#dc2626';
                        btnClose.style.display = 'inline-block';
                    } else if (completed) {
                        progressBar.style.background = 'linear-gradient(90deg, #10b981, #059669)';
                        progressText.style.color = '#059669';
                        btnClose.style.display = 'inline-block';
                    }
                });
                
                // Afficher les statistiques apr√®s t√©l√©chargement
                if (finalStats) {
                    downloadStats.style.display = 'block';
                    downloadStats.innerHTML = `
                        <strong>T√©l√©chargement termin√© !</strong><br>
                        üìä <strong>${finalStats.claims || 0}</strong> sinistres<br>
                        üë• <strong>${finalStats.clients || 0}</strong> clients<br>
                        üìÑ <strong>${finalStats.contracts || 0}</strong> contrats<br>
                        <br>
                        <em>Vous pouvez maintenant utiliser l'application hors ligne.</em>
                    `;
                }
            } catch (error) {
                console.error('Erreur lors du t√©l√©chargement:', error);
                progressBar.style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
                progressText.textContent = 'Erreur: ' + error.message;
                progressText.style.color = '#dc2626';
                btnClose.style.display = 'inline-block';
            }
        };
        
        // Gestionnaires d'√©v√©nements pour la modale
        document.addEventListener('DOMContentLoaded', () => {
            const btnStart = document.getElementById('btn-start-download');
            const btnSkip = document.getElementById('btn-skip-download');
            const btnClose = document.getElementById('btn-close-download');
            const btnSyncOffline = document.getElementById('btn-sync-offline');
            
            if (btnStart) {
                btnStart.addEventListener('click', startOfflineDownload);
            }
            
            if (btnSkip) {
                btnSkip.addEventListener('click', closeOfflineDownloadModal);
            }
            
            if (btnClose) {
                btnClose.addEventListener('click', closeOfflineDownloadModal);
            }
            
            if (btnSyncOffline) {
                btnSyncOffline.addEventListener('click', () => {
                    showOfflineDownloadModal();
                });
            }
            
            // Initialiser l'√©tat du bouton au chargement
            updateOnlineStatus();
        });
    </script>
</body>
</html>
